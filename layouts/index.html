{{ define "main" }}
<div class="container">
  <h1>Email Link Generator</h1>

  <form id="emailForm">
    <div class="form-group">
      <label for="to">To: <small>(comma-separated for multiple)</small></label>
      <input
        type="text"
        id="to"
        name="to"
        required
        placeholder="email@example.com, another@example.com"
      />
    </div>

    <div class="form-group">
      <label for="subject">Subject:</label>
      <input type="text" id="subject" name="subject" />
    </div>

    <div class="form-group">
      <label for="body"
        >Body: <small id="charCount">(0/2000 characters)</small></label
      >
      <textarea
        id="body"
        name="body"
        maxlength="2000"
        placeholder="Enter your email message here..."
      ></textarea>
    </div>

    <button type="submit">Generate Shortlink</button>
  </form>

  <div id="resultSection" class="result-section">
    <h3>Your Email Shortlink:</h3>
    <div id="shortlink" class="shortlink"></div>
    <button id="copyShortBtn">Copy Shortlink</button>
    <div id="copyMessage"></div>
  </div>
</div>

<script>
  document.getElementById("emailForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const to = document.getElementById("to").value.trim();
    const subject = document.getElementById("subject").value;
    const body = document.getElementById("body").value;

    // Clean and format email addresses
    const cleanEmails = (emailString) => {
      return emailString
        .split(",")
        .map((email) => email.trim())
        .filter((email) => email)
        .join(",");
    };

    const cleanTo = cleanEmails(to);

    let mailtoURL = "mailto:" + cleanTo;
    const params = [];

    if (subject) {
      params.push("subject=" + encodeURIComponent(subject));
    }
    if (body) {
      params.push("body=" + encodeURIComponent(body));
    }

    if (params.length > 0) {
      mailtoURL += "?" + params.join("&");
    }

    // Show result section and clear previous messages
    document.getElementById("resultSection").classList.add("show");
    document.getElementById("copyMessage").textContent = "";
    document.getElementById("shortlink").textContent =
      "Generating shortlink...";

    // Smooth scroll to results section
    setTimeout(() => {
      document.getElementById("resultSection").scrollIntoView({
        behavior: "smooth",
        block: "start",
      });
    }, 100);

    // Disable submit button while generating
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = "Generating...";

    // Directly generate shortlink
    generateShortlink(mailtoURL, submitBtn);
  });

  function generateShortlink(mailtoURL, submitBtn) {
    // Scaleway Functions endpoint
    const serverlessUrl =
      "https://emaillinksv1pcwdkc-shorten.functions.fnc.fr-par.scw.cloud/shorten";

    fetch(serverlessUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ url: mailtoURL }),
    })
      .then((response) => {
        if (!response.ok) {
          return response.json().then((data) => {
            throw new Error(data.error || "Network response was not ok");
          });
        }
        return response.json();
      })
      .then((data) => {
        if (data.shortUrl) {
          document.getElementById("shortlink").textContent = data.shortUrl;
        } else {
          throw new Error("No shortUrl in response");
        }
      })
      .catch((error) => {
        const errorMessage = error.message.includes("try again later")
          ? error.message
          : "Failed to generate shortlink";
        document.getElementById("shortlink").textContent =
          "Error generating shortlink";
        document.getElementById(
          "copyMessage"
        ).innerHTML = `<div class="error-message">${errorMessage}</div>`;
      })
      .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = "Generate Shortlink";
      });
  }

  document
    .getElementById("copyShortBtn")
    .addEventListener("click", function () {
      const shortlink = document.getElementById("shortlink").textContent;

      // Don't copy if it's still generating or there's an error
      if (
        shortlink === "Generating shortlink..." ||
        shortlink === "Error generating shortlink"
      ) {
        return;
      }

      navigator.clipboard
        .writeText(shortlink)
        .then(function () {
          document.getElementById("copyMessage").innerHTML =
            '<div class="success-message">Shortlink copied to clipboard!</div>';
        })
        .catch(function () {
          document.getElementById("copyMessage").innerHTML =
            '<div class="error-message">Failed to copy shortlink</div>';
        });
    });

  // Character counter for body field
  const bodyField = document.getElementById("body");
  const charCount = document.getElementById("charCount");

  bodyField.addEventListener("input", function () {
    const currentLength = bodyField.value.length;
    charCount.textContent = `(${currentLength}/2000 characters)`;

    if (currentLength > 1900) {
      charCount.style.color = "#dc3545"; // Red warning
    } else {
      charCount.style.color = "#6c757d"; // Default gray
    }
  });
</script>
{{ end }}
